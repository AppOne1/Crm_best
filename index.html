<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CRM Financial Software</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #facc15;
      --primary-dark: #d4b46a;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --success: #22c55e;
      --danger: #ef4444;
      --info: #3b82f6;
      --warning: #f97316;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      direction: rtl;
      overflow-x: hidden;
      font-size: 14px;
    }

    /* ==================== AUTH ==================== */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #1e3a5f 100%);
    }

    .auth-box {
      background: linear-gradient(145deg, var(--bg-card), #172033);
      padding: 40px 30px;
      border-radius: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(212, 180, 106, 0.2);
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auth-box h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 800;
    }

    .auth-box input {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 16px;
      border-radius: 12px;
      border: none;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 15px;
      box-shadow: inset 3px 3px 6px rgba(0,0,0,0.4);
      transition: all 0.3s;
    }

    .auth-box input:focus {
      outline: 2px solid var(--primary-dark);
      transform: translateY(-2px);
    }

    .auth-links {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .auth-links a {
      color: var(--primary-dark);
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .auth-links a:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    /* ==================== HEADER ==================== */
    .topbar {
      height: 70px;
      background: linear-gradient(145deg, var(--bg-card), #172033);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(212, 180, 106, 0.2);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
    }

    .app-title {
      font-size: clamp(14px, 3vw, 18px);
      font-weight: 800;
      color: var(--primary);
      text-shadow: 0 0 15px rgba(250,204,21,0.5), 0 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 1px;
      white-space: nowrap;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      padding: 4px 12px;
      border-radius: 8px;
      position: relative;
    }

    .app-title::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(145deg, rgba(250,204,21,0.1), rgba(212,180,106,0.05));
      border-radius: 8px;
      border: 1px solid rgba(250,204,21,0.2);
      z-index: -1;
    }

    .business-display {
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(145deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2));
      padding: 8px 16px;
      border-radius: 12px;
      border: 1px solid rgba(212, 180, 106, 0.2);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .business-display-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .business-display-item strong {
      color: var(--primary);
      font-weight: 600;
    }

    .business-display-icon {
      font-size: 14px;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .datetime-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255,255,255,0.05);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(212, 180, 106, 0.2);
      min-width: 80px;
    }

    #clock {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }

    #date {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .lang-switch {
      display: flex;
      gap: 4px;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-icon:hover {
      background: var(--primary);
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(250,204,21,0.3);
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(34, 197, 94, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--success);
      font-size: 12px;
      color: var(--success);
      font-weight: 600;
    }

    /* ==================== SIDEBAR ==================== */
    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, var(--bg-card) 0%, #172033 100%);
      height: calc(100vh - 70px);
      position: fixed;
      right: 0;
      top: 70px;
      padding: 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: -4px 0 20px rgba(0,0,0,0.4);
      border-left: 1px solid rgba(212, 180, 106, 0.1);
      overflow-y: auto;
      z-index: 999;
      transition: transform 0.3s ease;
    }

    .menu-item {
      width: 100%;
      padding: 14px;
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border-radius: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .menu-item::before {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
      transform: scaleY(0);
      transition: transform 0.3s;
    }

    .menu-item:hover, .menu-item.active {
      background: linear-gradient(145deg, rgba(250,204,21,0.1), rgba(250,204,21,0.05));
      transform: translateX(-5px);
    }

    .menu-item.active::before {
      transform: scaleY(1);
    }

    .menu-icon {
      font-size: 22px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
    }

    .menu-item.active .menu-icon {
      background: var(--primary);
      color: #000;
    }

    .menu-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.3s;
    }

    .menu-item.active .menu-text {
      color: var(--primary);
      font-weight: 700;
    }

    /* ==================== MAIN PANEL ==================== */
    .display-panel {
      margin-right: 220px;
      margin-top: 70px;
      padding: 24px;
      min-height: calc(100vh - 70px);
      background: var(--bg-dark);
    }

    .page {
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .page h2 {
      font-size: 22px;
      margin-bottom: 24px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
    }

    /* ==================== COMPACT STATS ==================== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: linear-gradient(145deg, var(--bg-card), #172033);
      padding: 16px 12px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 4px 0 rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
      transform: translateY(0);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4), 0 6px 0 rgba(0,0,0,0.2);
    }

    .stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    }

    .stat-number {
      font-size: 20px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 4px;
      text-shadow: 0 0 8px rgba(250,204,21,0.3);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* ==================== CARDS ==================== */
    .big-card {
      background: linear-gradient(145deg, var(--bg-card), #172033);
      padding: 20px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .big-card h3 {
      color: var(--primary);
      font-size: 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    /* ==================== TOOLBAR ==================== */
    .page-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border-radius: 12px;
      border: none;
      background: var(--bg-card);
      color: var(--text);
      font-size: 14px;
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
    }

    .search-box::after {
      content: 'ğŸ”';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    /* ==================== BUTTONS ==================== */
    .btn-3d {
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.3), 0 6px 12px rgba(0,0,0,0.2);
      transition: all 0.2s;
      position: relative;
      top: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-3d:active {
      transform: translateY(4px);
      box-shadow: 0 0 0 rgba(0,0,0,0.3);
    }

    .btn-3d.small {
      padding: 8px 12px;
      font-size: 11px;
      border-radius: 8px;
    }

    .btn-3d.wide {
      width: 100%;
    }

    .btn-3d.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #000;
    }

    .btn-3d.secondary {
      background: linear-gradient(135deg, #475569, #334155);
      color: var(--text);
    }

    .btn-3d.success {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: #fff;
    }

    .btn-3d.danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: #fff;
    }

    .btn-3d.info {
      background: linear-gradient(135deg, var(--info), #2563eb);
      color: #fff;
    }

    .btn-3d.warning {
      background: linear-gradient(135deg, var(--warning), #ea580c);
      color: #fff;
    }

    /* ==================== TABLES ==================== */
    .table-container {
      overflow-x: auto;
      background: var(--bg-card);
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      min-width: 600px;
    }

    .data-table th {
      background: rgba(0,0,0,0.3);
      padding: 12px 8px;
      color: var(--primary);
      font-weight: 700;
      text-align: center;
      border-bottom: 2px solid var(--primary-dark);
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    .data-table td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s;
    }

    .data-table tr:hover td {
      background: rgba(255,255,255,0.03);
    }

    /* ==================== FORMS ==================== */
    .pretty-box {
      background: linear-gradient(145deg, var(--bg-card), #172033);
      padding: 20px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    .pretty-box h3 {
      color: var(--primary);
      font-size: 15px;
      margin-bottom: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      margin-bottom: 16px;
    }

    .form-row label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
    }

    .form-row input,
    .form-row select,
    .form-row textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: var(--bg-dark);
      color: var(--text);
      font-size: 14px;
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
      transition: all 0.3s;
    }

    .form-row input:focus,
    .form-row select:focus,
    .form-row textarea:focus {
      outline: 2px solid var(--primary-dark);
      transform: translateY(-2px);
    }

    .form-row input.currency-input {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: left;
      direction: ltr;
    }

    /* ==================== STATUS ==================== */
    .status-pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s;
    }

    .status-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .status-ok {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: #fff;
    }

    .status-debt {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff;
    }

    .status-pending {
      background: linear-gradient(135deg, var(--warning), #ea580c);
      color: #fff;
    }

    .status-done {
      background: linear-gradient(135deg, var(--info), #2563eb);
      color: #fff;
    }

    .status-archive {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: #fff;
    }

    .amount-total { color: var(--primary); font-weight: 700; }
    .amount-paid { color: var(--success); font-weight: 700; }
    .amount-remaining { color: var(--danger); font-weight: 700; }

    /* ==================== PAYMENT TYPES ==================== */
    .pay-pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      display: inline-block;
    }

    .pay-cash { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .pay-card { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .pay-bank { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .pay-check { background: linear-gradient(135deg, #f97316, #ea580c); }
    .pay-crypto { background: linear-gradient(135deg, #f59e0b, #d97706); }

    /* ==================== OPERATIONS LAYOUT ==================== */
    .operations-layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 20px;
    }

    .op-form {
      position: sticky;
      top: 90px;
      height: fit-content;
    }

    /* ==================== MODALS ==================== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
      padding: 20px;
    }

    .modal-content {
      background: linear-gradient(145deg, var(--bg-card), #172033);
      border-radius: 24px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-content.small {
      max-width: 450px;
    }

    .modal-content.compact {
      max-width: 700px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-header h3 {
      color: var(--primary);
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* ==================== CUSTOMER INFO COMPACT ==================== */
    .customer-info-compact {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .info-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 12px;
      border-right: 3px solid var(--primary-dark);
      transition: all 0.3s;
    }

    .info-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-2px);
    }

    .info-label {
      font-size: 10px;
      color: var(--primary-dark);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .info-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }

    .info-value.debt { color: var(--danger); }
    .info-value.paid { color: var(--success); }

    /* ==================== STAGES & PAYMENTS ==================== */
    .stage-item, .payment-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      border-right: 3px solid var(--info);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .stage-item:hover, .payment-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(-5px);
    }

    .stage-content, .payment-content {
      flex: 1;
    }

    .stage-text {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
    }

    .stage-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .stage-amount {
      background: var(--primary);
      color: #000;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 10px;
    }

    /* ==================== CURRENCY SELECTOR ==================== */
    .currency-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .currency-option {
      padding: 10px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      font-size: 13px;
      font-weight: 600;
    }

    .currency-option:hover, .currency-option.active {
      background: rgba(250,204,21,0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* ==================== ACTIVATION BOX ==================== */
    .activation-box {
      background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .activation-box.active {
      background: linear-gradient(145deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border-color: rgba(34, 197, 94, 0.3);
    }

    .activation-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .activation-status.inactive { color: var(--danger); }
    .activation-status.active { color: var(--success); }

    .license-info {
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 12px;
    }

    .license-info div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .license-info div:last-child { margin-bottom: 0; }

    /* ==================== ACTIVITIES ==================== */
    .activity-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .activity-list li {
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border-right: 3px solid var(--primary-dark);
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.3s;
    }

    .activity-list li:hover {
      background: rgba(255,255,255,0.06);
      transform: translateX(-5px);
    }

    /* ==================== TOOLTIP ==================== */
    .tooltip {
      position: relative;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s;
      margin-bottom: 8px;
      z-index: 1000;
    }

    .tooltip:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }

    /* ==================== DEBTORS COMPACT ==================== */
    .debtor-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      margin-bottom: 8px;
      border-right: 3px solid var(--danger);
      transition: all 0.3s;
    }

    .debtor-item:hover {
      background: rgba(255,255,255,0.06);
      transform: translateX(-5px);
    }

    .debtor-name {
      font-weight: 600;
      color: var(--text);
    }

    .debtor-amount {
      color: var(--danger);
      font-weight: 700;
      font-size: 13px;
    }

    /* ==================== MOBILE RESPONSIVE ==================== */
    @media (max-width: 1024px) {
      .operations-layout {
        grid-template-columns: 1fr;
      }
      .op-form {
        position: static;
      }
      
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(100%);
        width: 280px;
        z-index: 1500;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .display-panel {
        margin-right: 0;
        padding: 16px;
      }
      
      .menu-toggle {
        display: flex !important;
      }
      
      .customer-info-compact {
        grid-template-columns: 1fr;
      }
      
      .modal-two-cols {
        grid-template-columns: 1fr !important;
      }
      
      .business-display {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .topbar {
        padding: 0 12px;
        height: 60px;
      }
      
      .app-title {
        font-size: 12px;
      }
      
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .stat-card {
        padding: 12px 8px;
      }
      
      .stat-number {
        font-size: 16px;
      }
      
      .page h2 {
        font-size: 16px;
      }
      
      .btn-3d {
        padding: 10px 14px;
        font-size: 12px;
      }
      
      .table-container {
        padding: 12px;
        overflow-x: scroll;
      }
      
      .data-table {
        font-size: 11px;
      }
      
      .data-table th, .data-table td {
        padding: 8px 4px;
      }
      
      .modal-content {
        margin: 10px;
        max-height: 95vh;
      }
    }

    /* ==================== MOBILE MENU TOGGLE ==================== */
    .menu-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #000;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(250,204,21,0.4);
      z-index: 1600;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1400;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* ==================== SCROLLBAR ==================== */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    /* ==================== PRINT ==================== */
    @media print {
      .topbar, .sidebar, .menu-toggle, .btn-3d, .modal-actions {
        display: none !important;
      }
      .display-panel {
        margin: 0;
        padding: 20px;
      }
      .modal {
        position: static;
        display: block !important;
        background: white;
      }
      .modal-content {
        box-shadow: none;
        max-width: 100%;
        color: #000;
      }
    }

    /* ==================== UTILITIES ==================== */
    .text-center { text-align: center; }
    .mt-2 { margin-top: 8px; }
    .mb-2 { margin-bottom: 8px; }
    .hidden { display: none !important; }

    /* ==================== LOADING ==================== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div id="auth-page" class="auth-container">
    <div class="auth-box" id="login-box">
      <h2 id="auth-login-title">ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h2>
      <input type="email" id="login-email" placeholder="ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„">
      <input type="password" id="login-password" placeholder="ğŸ”’ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
      <button class="btn-3d primary wide" onclick="login()" id="btn-login">ÙˆØ±ÙˆØ¯</button>
      <div class="auth-links">
        <a onclick="showForgotPassword()" id="link-forgot">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù…</a> | 
        <a onclick="showRegister()" id="link-register">Ø«Ø¨Øª Ù†Ø§Ù…</a>
      </div>
    </div>

    <div class="auth-box" id="register-box" style="display:none;">
      <h2 id="auth-register-title">ğŸ“ Ø«Ø¨Øª Ù†Ø§Ù…</h2>
      <input type="text" id="reg-name" placeholder="ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ù…Ù„">
      <input type="email" id="reg-email" placeholder="ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„">
      <input type="password" id="reg-password" placeholder="ğŸ”’ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
      <input type="password" id="reg-password-confirm" placeholder="ğŸ”’ ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
      <button class="btn-3d success wide" onclick="register()" id="btn-register">Ø«Ø¨Øª Ù†Ø§Ù…</button>
      <div class="auth-links">
        <a onclick="showLogin()" id="link-back-login">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</a>
      </div>
    </div>

    <div class="auth-box" id="forgot-box" style="display:none;">
      <h2 id="auth-forgot-title">ğŸ”„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø²</h2>
      <p style="color:#94a3b8; margin-bottom:20px; text-align:center; font-size:13px;" id="forgot-desc">
        Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
      </p>
      <input type="email" id="forgot-email" placeholder="ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„">
      <button class="btn-3d primary wide" onclick="sendResetLink()" id="btn-send-reset">Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú©</button>
      <div class="auth-links">
        <a onclick="showLogin()" id="link-back-login2">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</a>
      </div>
    </div>
  </div>

  <div id="main-app" style="display:none;">
    
    <header class="topbar">
      <div class="top-left">
        <div class="app-title" id="app-title">Ø¨Ù‡ØªØ±ÛŒÙ† Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± Ù…Ø§Ù„ÛŒ Ùˆ CRM</div>
        <div class="business-display" id="business-display" style="display: none;">
          <div class="business-display-item">
            <span class="business-display-icon">ğŸ¢</span>
            <span id="display-biz-name">-</span>
          </div>
          <div class="business-display-item">
            <span class="business-display-icon">ğŸ“</span>
            <span id="display-biz-phone">-</span>
          </div>
          <div class="business-display-item">
            <span class="business-display-icon">ğŸ“</span>
            <span id="display-biz-address">-</span>
          </div>
        </div>
      </div>
      
      <div class="top-right">
        <div class="datetime-display">
          <div id="clock">00:00</div>
          <div id="date">----/--/--</div>
        </div>
        
        <div class="lang-switch">
          <button class="btn-icon tooltip" data-tooltip="ÙØ§Ø±Ø³ÛŒ" onclick="setLang('fa')">FA</button>
          <button class="btn-icon tooltip" data-tooltip="English" onclick="setLang('en')">EN</button>
        </div>
        
        <div class="user-badge" id="user-badge">
          <span>ğŸ‘¤</span>
          <span id="username-display">Ú©Ø§Ø±Ø¨Ø±</span>
        </div>
        
        <button class="btn-icon tooltip" data-tooltip="Ø®Ø±ÙˆØ¬" onclick="logout()" title="Ø®Ø±ÙˆØ¬">ğŸšª</button>
      </div>
    </header>

    <nav class="sidebar" id="sidebar">
      <div class="menu-item active" data-page="dashboard" onclick="showPage('dashboard')">
        <div class="menu-icon tooltip" data-tooltip="Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯">ğŸ“Š</div>
        <div class="menu-text" data-key="menu_dashboard">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
      </div>
      <div class="menu-item" data-page="customers" onclick="showPage('customers')">
        <div class="menu-icon tooltip" data-tooltip="Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§">ğŸ‘¥</div>
        <div class="menu-text" data-key="menu_customers">Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</div>
      </div>
      <div class="menu-item" data-page="operations" onclick="showPage('operations')">
        <div class="menu-icon tooltip" data-tooltip="Ø¹Ù…Ù„ÛŒØ§Øª">âš™ï¸</div>
        <div class="menu-text" data-key="menu_operations">Ø¹Ù…Ù„ÛŒØ§Øª</div>
      </div>
      <div class="menu-item" data-page="finance" onclick="showPage('finance')">
        <div class="menu-icon tooltip" data-tooltip="Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ">ğŸ’°</div>
        <div class="menu-text" data-key="menu_finance">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</div>
      </div>
      <div class="menu-item" data-page="archive" onclick="showPage('archive')">
        <div class="menu-icon tooltip" data-tooltip="Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ">ğŸ“¦</div>
        <div class="menu-text" data-key="menu_archive">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</div>
      </div>
      <div class="menu-item" data-page="settings" onclick="showPage('settings')">
        <div class="menu-icon tooltip" data-tooltip="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">âš™ï¸</div>
        <div class="menu-text" data-key="menu_settings">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
      </div>
    </nav>

    <main class="display-panel">

      <div id="page-dashboard" class="page">
        <h2 data-key="title_dashboard">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</h2>
        
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-number" id="stat-customers">0</div>
            <div class="stat-label" data-key="stat_customers">Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="stat-services">0</div>
            <div class="stat-label" data-key="stat_services">Ø®Ø¯Ù…Ø§Øª</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="stat-operations">0</div>
            <div class="stat-label" data-key="stat_operations">Ø¹Ù…Ù„ÛŒØ§Øª</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="stat-debt">0</div>
            <div class="stat-label" data-key="stat_debt">Ù…Ø§Ù†Ø¯Ù‡ Ú©Ù„</div>
          </div>
        </div>

        <div class="big-card">
          <h3 data-key="dashboard_debtors">ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</h3>
          <div id="dashboard-debtors-list">
            <div style="text-align:center; color:var(--text-muted); padding:20px;" data-key="empty_debtors">Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù‡Ú©Ø§Ø±</div>
          </div>
        </div>

        <div class="big-card">
          <h3 data-key="dashboard_activities">ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</h3>
          <ul class="activity-list" id="activity-list">
            <li data-key="empty_activity">Ø®Ø§Ù„ÛŒ...</li>
          </ul>
        </div>
      </div>

      <div id="page-customers" class="page" style="display:none;">
        <h2 data-key="title_customers">ğŸ‘¥ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</h2>
        <div class="page-toolbar">
          <div class="search-box">
            <input type="text" id="search-customers" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ..." data-key-placeholder="ph_search_customer">
          </div>
          <button class="btn-3d primary" onclick="addCustomer()" data-key="btn_add_customer">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div class="table-container">
          <table class="data-table" id="customers-table">
            <thead>
              <tr>
                <th data-key="th_id">Ø´Ù†Ø§Ø³Ù‡</th>
                <th data-key="th_name">Ù†Ø§Ù…</th>
                <th data-key="th_phone">ØªÙ…Ø§Ø³</th>
                <th data-key="th_total">Ù…Ø¨Ù„Øº Ú©Ù„</th>
                <th data-key="th_remaining">Ù…Ø§Ù†Ø¯Ù‡</th>
                <th data-key="th_status">ÙˆØ¶Ø¹ÛŒØª</th>
                <th data-key="th_actions">Ø¹Ù…Ù„ÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="page-operations" class="page" style="display:none;">
        <h2 data-key="title_operations">âš™ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø¯Ù…Øª</h2>
        <div class="operations-layout">
          <div class="pretty-box op-form">
            <h3 data-key="op_new">ğŸ“ Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯</h3>
            <div class="form-row">
              <label data-key="lbl_customer">Ù…Ø´ØªØ±ÛŒ:</label>
              <select id="op-customer"></select>
            </div>
            <div class="form-row">
              <label data-key="lbl_service">Ø®Ø¯Ù…Øª:</label>
              <select id="op-service" onchange="autoFillPrice()"></select>
            </div>
            <div class="form-row">
              <button class="btn-3d info small wide" onclick="quickAddService()" data-key="btn_quick_add_service">+ ØªØ¹Ø±ÛŒÙ Ø®Ø¯Ù…Øª Ø¬Ø¯ÛŒØ¯</button>
            </div>
            <div class="form-row">
              <label data-key="lbl_total">Ù…Ø¨Ù„Øº Ú©Ù„:</label>
              <input type="text" id="op-total" class="currency-input" placeholder="0" oninput="formatCurrencyInput(this)">
            </div>
            <div class="form-row">
              <label data-key="lbl_paid">Ø¯Ø±ÛŒØ§ÙØªÛŒ:</label>
              <input type="text" id="op-paid" class="currency-input" placeholder="0" oninput="formatCurrencyInput(this)">
            </div>
            <div class="form-row">
              <label data-key="lbl_pay_type">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª:</label>
              <select id="op-pay-type">
                <option value="Ù†Ù‚Ø¯ÛŒ">ğŸ’µ Ù†Ù‚Ø¯ÛŒ</option>
                <option value="Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª">ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</option>
                <option value="ÙˆØ§Ø±ÛŒØ² Ø¨Ø§Ù†Ú©ÛŒ">ğŸ¦ ÙˆØ§Ø±ÛŒØ² Ø¨Ø§Ù†Ú©ÛŒ</option>
                <option value="Ú†Ú©">ğŸ“„ Ú†Ú©</option>
                <option value="Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„">â‚¿ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</option>
              </select>
            </div>
            <div class="form-row">
              <label data-key="lbl_status">ÙˆØ¶Ø¹ÛŒØª:</label>
              <select id="op-status">
                <option value="pending">ğŸŸ  Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…</option>
                <option value="done">ğŸ”µ Ø§ØªÙ…Ø§Ù…</option>
                <option value="archive">âš« Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</option>
              </select>
            </div>
            <div class="form-row">
              <label data-key="lbl_desc">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
              <textarea id="op-desc" rows="2"></textarea>
            </div>
            <button class="btn-3d primary wide" onclick="saveOperation()" data-key="btn_save">ğŸ’¾ Ø«Ø¨Øª</button>
          </div>

          <div class="op-list">
            <div class="search-box mb-2">
              <input type="text" id="search-operations" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." data-key-placeholder="ph_search">
            </div>
            <div class="table-container">
              <table class="data-table" id="operations-table">
                <thead>
                  <tr>
                    <th data-key="th_date">ØªØ§Ø±ÛŒØ®</th>
                    <th data-key="th_customer">Ù…Ø´ØªØ±ÛŒ</th>
                    <th data-key="th_service">Ø®Ø¯Ù…Øª</th>
                    <th data-key="th_total">Ú©Ù„</th>
                    <th data-key="th_paid">Ø¯Ø±ÛŒØ§ÙØªÛŒ</th>
                    <th data-key="th_remaining">Ù…Ø§Ù†Ø¯Ù‡</th>
                    <th data-key="th_status">ÙˆØ¶Ø¹ÛŒØª</th>
                    <th data-key="th_actions">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div id="page-finance" class="page" style="display:none;">
        <h2 data-key="title_finance">ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</h2>
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-number" id="stat-income">0</div>
            <div class="stat-label" data-key="stat_income">Ø¯Ø±ÛŒØ§ÙØªÛŒ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="stat-expense">0</div>
            <div class="stat-label" data-key="stat_expense">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="stat-net">0</div>
            <div class="stat-label" data-key="stat_net">Ø®Ø§Ù„Øµ</div>
          </div>
        </div>

        <div class="page-toolbar">
          <div>
            <button class="btn-3d secondary" onclick="showReport('week')" data-key="btn_week_report">ğŸ“… Ù‡ÙØªÚ¯ÛŒ</button>
            <button class="btn-3d secondary" onclick="showReport('month')" data-key="btn_month_report">ğŸ“† Ù…Ø§Ù‡Ø§Ù†Ù‡</button>
          </div>
          <div id="report-output" style="color: var(--primary); font-weight:700;"></div>
        </div>

        <div class="table-container">
          <table class="data-table" id="finance-table">
            <thead>
              <tr>
                <th data-key="th_customer">Ù…Ø´ØªØ±ÛŒ</th>
                <th data-key="th_total_amount">Ù…Ø¨Ù„Øº Ú©Ù„</th>
                <th data-key="th_actions">Ø¬Ø²ÛŒÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="page-archive" class="page" style="display:none;">
        <h2 data-key="title_archive">ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</h2>
        <div class="search-box mb-2">
          <input type="text" id="search-archive" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." data-key-placeholder="ph_search">
        </div>
        <div class="table-container">
          <table class="data-table" id="archive-table">
            <thead>
              <tr>
                <th data-key="th_date">ØªØ§Ø±ÛŒØ®</th>
                <th data-key="th_customer">Ù…Ø´ØªØ±ÛŒ</th>
                <th data-key="th_service">Ø®Ø¯Ù…Øª</th>
                <th data-key="th_total">Ú©Ù„</th>
                <th data-key="th_status">ÙˆØ¶Ø¹ÛŒØª</th>
                <th data-key="th_actions">Ø¬Ø²ÛŒÛŒØ§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="page-settings" class="page" style="display:none;">
        <h2 data-key="title_settings">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
        
        <div class="activation-box" id="activation-box">
          <div class="activation-status inactive" id="activation-status-text">
            <span>ğŸ”’</span>
            <span data-key="activation_locked">Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„</span>
          </div>
          <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;" data-key="activation_desc">
            Ù¾Ø³ Ø§Ø² Û±Û° Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø¯Ù…ØªØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø±ÛŒØ¯.
          </p>
          <div class="license-info" id="license-info" style="display:none;">
            <div>
              <span data-key="license_type">Ù†ÙˆØ¹ Ù„Ø§ÛŒØ³Ù†Ø³:</span>
              <strong id="license-type" style="color: var(--primary);">-</strong>
            </div>
            <div>
              <span data-key="license_expire">Ø§Ù†Ù‚Ø¶Ø§:</span>
              <strong id="license-expire" style="color: var(--primary);">-</strong>
            </div>
          </div>
          <button class="btn-3d primary" onclick="showActivationModal()" data-key="btn_activate">ğŸ”‘ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
          <p style="color: var(--text-muted); font-size: 11px; margin-top: 10px;">
            <span data-key="activation_contact">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ØŒ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø²ÛŒØ± Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒØ¯:</span><br>
            <strong style="color: var(--primary);">alavipoco@gmail.com</strong>
          </p>
        </div>

        <div class="pretty-box">
          <h3 data-key="settings_business_info">ğŸ¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±</h3>
          <div class="form-row">
            <label data-key="lbl_biz_name">Ù†Ø§Ù… Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±:</label>
            <input type="text" id="settings-biz-name" placeholder="Ù…Ø«Ø§Ù„: ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„">
          </div>
          <div class="form-row">
            <label data-key="lbl_biz_phone">ØªÙ„ÙÙ†:</label>
            <input type="text" id="settings-biz-phone" placeholder="Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹">
          </div>
          <div class="form-row">
            <label data-key="lbl_biz_address">Ø¢Ø¯Ø±Ø³:</label>
            <textarea id="settings-biz-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„..."></textarea>
          </div>
          <button class="btn-3d primary" onclick="saveBusinessInfo()" data-key="btn_save_business">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
        </div>

        <div class="pretty-box">
          <h3 data-key="settings_currency">ğŸ’± ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„</h3>
          <div class="currency-selector">
            <div class="currency-option active" onclick="setCurrency('IRR')">Ø±ÛŒØ§Ù„/ØªÙˆÙ…Ø§Ù†</div>
            <div class="currency-option" onclick="setCurrency('USD')">Ø¯Ù„Ø§Ø± $</div>
            <div class="currency-option" onclick="setCurrency('EUR')">ÛŒÙˆØ±Ùˆ â‚¬</div>
            <div class="currency-option" onclick="setCurrency('GBP')">Ù¾ÙˆÙ†Ø¯ Â£</div>
            <div class="currency-option" onclick="setCurrency('BTC')">Ø¨ÛŒØªÚ©Ùˆ â‚¿</div>
          </div>
          <div class="mt-2" style="color: var(--primary); font-weight:700;">
            <span data-key="current_currency">ÙˆØ§Ø­Ø¯ ÙØ¹Ù„ÛŒ:</span> <span id="current-currency">ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>

        <div class="pretty-box">
          <h3>ğŸŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡</h3>
          <p style="color:var(--text-muted); font-size:12px; margin-bottom:12px;" data-key="db_desc">
            Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ MySQL/PostgreSQL/MongoDB ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:
          </p>
          <div class="form-row">
            <input type="text" id="db-host" placeholder="Ù‡Ø§Ø³Øª (Ù…Ø«Ø§Ù„: localhost)">
          </div>
          <div class="form-row">
            <input type="text" id="db-port" placeholder="Ù¾ÙˆØ±Øª (Ù…Ø«Ø§Ù„: 3306)">
          </div>
          <div class="form-row">
            <input type="text" id="db-name" placeholder="Ù†Ø§Ù… Ø¯ÛŒØªØ§Ø¨ÛŒØ³">
          </div>
          <div class="form-row">
            <input type="text" id="db-user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
          </div>
          <div class="form-row">
            <input type="password" id="db-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
          </div>
          <div class="form-row">
            <input type="text" id="db-api" placeholder="API Endpoint (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
          </div>
          <button class="btn-3d success" onclick="saveDBConfig()" data-key="btn_save_db">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª DB</button>
          <button class="btn-3d info" onclick="testDBConnection()" style="margin-right:10px;" data-key="btn_test_db">ğŸ”— ØªØ³Øª Ø§ØªØµØ§Ù„</button>
        </div>

        <div class="pretty-box">
          <h3 data-key="settings_user_mgmt">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
          <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;" data-key="user_mgmt_desc">
            Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯. ØªÙˆØ¬Ù‡: ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ØªØ¹Ø±ÛŒÙ Ú©Ù†Ø¯.
          </p>
          <div id="user-list" style="margin-bottom: 12px; max-height: 200px; overflow-y: auto;">
          </div>
          <button class="btn-3d primary" onclick="showAddUserModal()" data-key="btn_add_user">+ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±</button>
        </div>

        <div class="pretty-box">
          <h3 data-key="settings_backup">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</h3>
          <button class="btn-3d success" onclick="exportData()" data-key="btn_export">ğŸ“¥ Export</button>
          <div class="mt-2">
            <input type="file" id="import-file" accept=".json" style="margin-bottom:10px;">
            <button class="btn-3d danger" onclick="importData()" data-key="btn_import">ğŸ“¤ Import</button>
          </div>
        </div>

        <div class="pretty-box">
          <h3 data-key="settings_reset">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</h3>
          <p style="color: var(--danger); font-size:12px;" data-key="reset_warning">Ù‡Ø´Ø¯Ø§Ø±: ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª!</p>
          <button class="btn-3d danger" onclick="resetAllData()" data-key="btn_reset">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
        </div>
      </div>

    </main>
  </div>

  <div id="customer-modal" class="modal">
    <div class="modal-content compact">
      <div class="modal-header">
        <h3 id="modal-title">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>
        <button class="btn-3d small secondary" onclick="closeCustomerModal()">âœ•</button>
      </div>
      
      <div class="modal-body">
        <div class="customer-info-compact" id="customer-info">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;" class="modal-two-cols">
          <div class="pretty-box" style="margin:0;">
            <h3>ğŸ’µ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯</h3>
            <div class="form-row">
              <select id="pay-type">
                <option value="Ù†Ù‚Ø¯ÛŒ">ğŸ’µ Ù†Ù‚Ø¯ÛŒ</option>
                <option value="Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª">ğŸ’³ Ú©Ø§Ø±Øª</option>
                <option value="ÙˆØ§Ø±ÛŒØ² Ø¨Ø§Ù†Ú©ÛŒ">ğŸ¦ Ø¨Ø§Ù†Ú©</option>
                <option value="Ú†Ú©">ğŸ“„ Ú†Ú©</option>
                <option value="Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„">â‚¿ Ú©Ø±ÛŒÙ¾ØªÙˆ</option>
              </select>
            </div>
            <div class="form-row">
              <input type="text" id="pay-amount" class="currency-input" placeholder="Ù…Ø¨Ù„Øº" oninput="formatCurrencyInput(this)">
            </div>
            <div class="form-row">
              <select id="pay-for-stage">
                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø±Ø­Ù„Ù‡ --</option>
              </select>
            </div>
            <button class="btn-3d success wide" onclick="addPayment()">Ø«Ø¨Øª</button>

            <div style="margin-top:16px; max-height:150px; overflow-y:auto;">
              <h4 style="color:var(--primary); font-size:12px; margin-bottom:8px;">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h4>
              <div id="payments-list"></div>
            </div>
          </div>

          <div class="pretty-box" style="margin:0;">
            <h3>ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ú©Ø§Ø±</h3>
            <div class="form-row">
              <input type="text" id="stage-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ø­Ù„Ù‡">
            </div>
            <div class="form-row">
              <input type="text" id="stage-amount" class="currency-input" placeholder="Ù…Ø¨Ù„Øº Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" oninput="formatCurrencyInput(this)">
            </div>
            <div class="form-row">
              <textarea id="stage-desc" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea>
            </div>
            <button class="btn-3d primary wide" onclick="addStage()">Ø§ÙØ²ÙˆØ¯Ù†</button>

            <div style="margin-top:16px; max-height:200px; overflow-y:auto;" id="stages-list">
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-3d secondary" onclick="showCustomerStagesModal()">ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ Ù…Ø±Ø§Ø­Ù„</button>
        <button class="btn-3d secondary" onclick="printProfile()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>
        <button class="btn-3d danger" onclick="closeCustomerModal()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <div id="stages-modal" class="modal">
    <div class="modal-content compact">
      <div class="modal-header">
        <h3>ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ú©Ø§Ø± Ù…Ø´ØªØ±ÛŒ</h3>
        <button class="btn-3d small secondary" onclick="closeStagesModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div id="stages-modal-content" style="max-height: 400px; overflow-y: auto;">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-3d secondary" onclick="closeStagesModal()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <div id="finance-modal" class="modal">
    <div class="modal-content compact">
      <div class="modal-header">
        <h3>ğŸ’µ Ø¬Ø²ÛŒÛŒØ§Øª Ù…Ø§Ù„ÛŒ</h3>
        <button class="btn-3d small secondary" onclick="closeFinanceModal()">âœ•</button>
      </div>
      <div class="modal-body" id="finance-modal-content">
      </div>
      <div class="modal-actions">
        <button class="btn-3d secondary" onclick="closeFinanceModal()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <div id="activation-modal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h3>ğŸ”‘ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±</h3>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
          Ù„Ø§ÛŒØ³Ù†Ø³ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:
        </p>
        <div class="form-row">
          <select id="license-type-select">
            <option value="1month">Û± Ù…Ø§Ù‡Ù‡</option>
            <option value="3month">Û³ Ù…Ø§Ù‡Ù‡</option>
            <option value="6month">Û¶ Ù…Ø§Ù‡Ù‡</option>
            <option value="1year">Û± Ø³Ø§Ù„Ù‡</option>
          </select>
        </div>
        <div class="form-row">
          <input type="text" id="activation-code" placeholder="Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-muted);">Ù…Ø¯Øª:</span>
            <strong id="license-duration" style="color: var(--success);">Û³Û° Ø±ÙˆØ²</strong>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-3d primary" onclick="activateWithCode()">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
        <button class="btn-3d secondary" onclick="closeActivationModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>

  <div id="add-user-modal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h3>ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h3>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>Ù†Ø§Ù…:</label>
          <input type="text" id="new-user-name" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„">
        </div>
        <div class="form-row">
          <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
          <input type="email" id="new-user-email" placeholder="email@example.com">
        </div>
        <div class="form-row">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
          <input type="password" id="new-user-password" placeholder="********">
        </div>
        <div class="form-row">
          <label>Ù†Ù‚Ø´:</label>
          <select id="new-user-role">
            <option value="user">Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</option>
            <option value="admin">Ø§Ø¯Ù…ÛŒÙ†</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-3d primary" onclick="addNewUser()">Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn-3d secondary" onclick="closeAddUserModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="modal">
    <div class="modal-content small">
      <div class="modal-header">
        <h3>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´ØªØ±ÛŒ</h3>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id">
        <div class="form-row">
          <label>Ù†Ø§Ù…:</label>
          <input type="text" id="edit-name">
        </div>
        <div class="form-row">
          <label>ØªÙ„ÙÙ†:</label>
          <input type="text" id="edit-phone">
        </div>
        <div class="form-row">
          <label>Ø§ÛŒÙ…ÛŒÙ„:</label>
          <input type="email" id="edit-email">
        </div>
        <div class="form-row">
          <label>Ø¢Ø¯Ø±Ø³:</label>
          <textarea id="edit-address" rows="2"></textarea>
        </div>
        <div class="form-row">
          <label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</label>
          <textarea id="edit-note" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-3d primary" onclick="saveEdit()">Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn-3d secondary" onclick="closeEditModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>

  <div id="archive-detail-modal" class="modal">
    <div class="modal-content compact">
      <div class="modal-header">
        <h3>ğŸ“¦ Ø¬Ø²ÛŒÛŒØ§Øª Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</h3>
        <button class="btn-3d small secondary" onclick="closeArchiveDetailModal()">âœ•</button>
      </div>
      <div class="modal-body" id="archive-detail-content">
      </div>
      <div class="modal-actions">
        <button class="btn-3d secondary" onclick="closeArchiveDetailModal()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIG & STATE ====================
    const APP_VERSION = '2.0.0';
    const TRIAL_LIMIT = 10;
    
    let currentLang = localStorage.getItem('crm_lang') || 'fa';
    let currentCurrency = localStorage.getItem('crm_currency') || 'IRR';
    let businessInfo = JSON.parse(localStorage.getItem('crm_business_info') || '{"name":"","phone":"","address":""}');
    let currentUser = JSON.parse(localStorage.getItem('crm_user') || 'null');
    let licenseData = JSON.parse(localStorage.getItem('crm_license') || 'null');
    
    let customers = [];
    let services = [];
    let operations = [];
    let finance = [];
    let stages = [];
    let activities = [];
    
    let db = null;
    let currentCustomerId = null;

    const CURRENCIES = {
      IRR: { symbol: 'ØªÙˆÙ…Ø§Ù†', locale: 'fa-IR', decimals: 0 },
      USD: { symbol: '$', locale: 'en-US', decimals: 2 },
      EUR: { symbol: 'â‚¬', locale: 'de-DE', decimals: 2 },
      GBP: { symbol: 'Â£', locale: 'en-GB', decimals: 2 },
      BTC: { symbol: 'â‚¿', locale: 'en-US', decimals: 8 }
    };

    const LICENSE_CODES = {
      'CRM-1M-2024': { type: '1month', days: 30, name: 'Û± Ù…Ø§Ù‡Ù‡' },
      'CRM-3M-2024': { type: '3month', days: 90, name: 'Û³ Ù…Ø§Ù‡Ù‡' },
      'CRM-6M-2024': { type: '6month', days: 180, name: 'Û¶ Ù…Ø§Ù‡Ù‡' },
      'CRM-1Y-2024': { type: '1year', days: 365, name: 'Û± Ø³Ø§Ù„Ù‡' }
    };

    // ==================== INITIALIZATION ====================
    async function init() {
      await initDB();
      await loadData();
      setupEventListeners();
      startClock();
      updateBusinessDisplay();
      
      if (currentUser) {
        showMainApp();
      } else {
        showAuth();
      }
    }

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('CRM_DB_v2', 3);
        
        request.onupgradeneeded = (e) => {
          const database = e.target.result;
          const stores = ['customers', 'services', 'operations', 'finance', 'stages', 'users'];
          stores.forEach(store => {
            if (!database.objectStoreNames.contains(store)) {
              database.createObjectStore(store, { keyPath: 'id', autoIncrement: true });
            }
          });
        };
        
        request.onsuccess = (e) => {
          db = e.target.result;
          resolve();
        };
        
        request.onerror = (e) => reject(e);
      });
    }

    async function loadData() {
      customers = await dbGetAll('customers');
      services = await dbGetAll('services');
      operations = await dbGetAll('operations');
      finance = await dbGetAll('finance');
      stages = await dbGetAll('stages');
    }

    function dbGetAll(store) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readonly');
        const objStore = tx.objectStore(store);
        const request = objStore.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function dbSave(store, data) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readwrite');
        const objStore = tx.objectStore(store);
        const request = objStore.put(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function dbDelete(store, id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(store, 'readwrite');
        const objStore = tx.objectStore(store);
        const request = objStore.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ==================== ACTIVATION SYSTEM ====================
    function checkActivation() {
      const opCount = operations.length;
      const isActive = isLicenseValid();
      
      updateActivationUI(isActive, opCount);
      
      if (opCount >= TRIAL_LIMIT && !isActive) {
        showActivationModal();
        return false;
      }
      return true;
    }

    function isLicenseValid() {
      if (!licenseData) return false;
      if (licenseData.expireDate) {
        return new Date() < new Date(licenseData.expireDate);
      }
      return false;
    }

    function updateActivationUI(isActive, opCount) {
      const box = document.getElementById('activation-box');
      const statusText = document.getElementById('activation-status-text');
      const licenseInfo = document.getElementById('license-info');
      
      if (isActive && licenseData) {
        box.classList.add('active');
        statusText.className = 'activation-status active';
        statusText.innerHTML = '<span>ğŸ”“</span><span>Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª</span>';
        licenseInfo.style.display = 'block';
        
        document.getElementById('license-type').textContent = licenseData.name || licenseData.type;
        document.getElementById('license-expire').textContent = new Date(licenseData.expireDate).toLocaleDateString('fa-IR');
      } else {
        box.classList.remove('active');
        statusText.className = 'activation-status inactive';
        statusText.innerHTML = '<span>ğŸ”’</span><span>Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„</span>';
        licenseInfo.style.display = 'none';
        
        if (opCount >= TRIAL_LIMIT) {
          alert('âš ï¸ Ù¾Ø§ÛŒØ§Ù† Ù†Ø³Ø®Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.');
          showActivationModal();
        }
      }
    }

    function showActivationModal() {
      document.getElementById('activation-modal').style.display = 'flex';
    }

    function closeActivationModal() {
      document.getElementById('activation-modal').style.display = 'none';
    }

    function activateWithCode() {
      const code = document.getElementById('activation-code').value.trim().toUpperCase();
      
      if (!code) {
        alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      const licenseInfo = LICENSE_CODES[code];
      
      if (licenseInfo) {
        const expireDate = new Date();
        expireDate.setDate(expireDate.getDate() + licenseInfo.days);
        
        licenseData = {
          code: code,
          type: licenseInfo.type,
          name: licenseInfo.name,
          expireDate: expireDate.toISOString(),
          activatedAt: new Date().toISOString()
        };
        
        localStorage.setItem('crm_license', JSON.stringify(licenseData));
        updateActivationUI(true, operations.length);
        closeActivationModal();
        alert('âœ… Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯!');
        addActivity('Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯ - ' + licenseInfo.name);
      } else {
        alert('âŒ Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!');
      }
    }

    // ==================== BUSINESS INFO ====================
    function updateBusinessDisplay() {
      const display = document.getElementById('business-display');
      const nameEl = document.getElementById('display-biz-name');
      const phoneEl = document.getElementById('display-biz-phone');
      const addressEl = document.getElementById('display-biz-address');
      
      if (businessInfo.name || businessInfo.phone || businessInfo.address) {
        display.style.display = 'flex';
        nameEl.textContent = businessInfo.name || '-';
        phoneEl.textContent = businessInfo.phone || '-';
        addressEl.textContent = businessInfo.address || '-';
      } else {
        display.style.display = 'none';
      }
      
      // Load in settings
      document.getElementById('settings-biz-name').value = businessInfo.name || '';
      document.getElementById('settings-biz-phone').value = businessInfo.phone || '';
      document.getElementById('settings-biz-address').value = businessInfo.address || '';
    }

    function saveBusinessInfo() {
      businessInfo = {
        name: document.getElementById('settings-biz-name').value.trim(),
        phone: document.getElementById('settings-biz-phone').value.trim(),
        address: document.getElementById('settings-biz-address').value.trim()
      };
      localStorage.setItem('crm_business_info', JSON.stringify(businessInfo));
      updateBusinessDisplay();
      addActivity('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
      alert('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
    }

    // ==================== CURRENCY FORMATTING ====================
    function formatNumber(num, showSymbol = true) {
      const curr = CURRENCIES[currentCurrency];
      const n = Number(num) || 0;
      
      let formatted;
      if (currentLang === 'fa') {
        const parts = n.toFixed(curr.decimals).split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1] || '';
        
        let persianInteger = '';
        let counter = 0;
        for (let i = integerPart.length - 1; i >= 0; i--) {
          persianInteger = integerPart[i] + persianInteger;
          counter++;
          if (counter === 3 && i > 0) {
            persianInteger = 'ØŒ' + persianInteger;
            counter = 0;
          }
        }
        
        const persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
        persianInteger = persianInteger.split('').map(char => {
          if (char >= '0' && char <= '9') return persianDigits[parseInt(char)];
          return char;
        }).join('');
        
        if (decimalPart && curr.decimals > 0) {
          const persianDecimal = decimalPart.split('').map(char => 
            char >= '0' && char <= '9' ? persianDigits[parseInt(char)] : char
          ).join('');
          formatted = persianInteger + '/' + persianDecimal;
        } else {
          formatted = persianInteger;
        }
      } else {
        formatted = n.toLocaleString('en-US', {
          minimumFractionDigits: curr.decimals,
          maximumFractionDigits: curr.decimals
        });
      }
      
      return showSymbol ? `${formatted} ${curr.symbol}` : formatted;
    }

    function parseNumber(str) {
      if (!str) return 0;
      
      let clean = str.toString()
        .replace(/[ØªÙˆÙ…Ø§Ù†$â‚¬Â£â‚¿]/g, '')
        .replace(/\s/g, '');
      
      const persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      const arabicDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      
      clean = clean.split('').map(char => {
        const pIndex = persianDigits.indexOf(char);
        if (pIndex > -1) return pIndex.toString();
        const aIndex = arabicDigits.indexOf(char);
        if (aIndex > -1) return aIndex.toString();
        return char;
      }).join('');
      
      clean = clean.replace(/,/g, '').replace(/ØŒ/g, '');
      clean = clean.replace(/\//g, '.');
      
      const result = parseFloat(clean);
      return isNaN(result) ? 0 : result;
    }

    function formatCurrencyInput(input) {
      let rawValue = input.value;
      
      const persianDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      const arabicDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      
      let clean = rawValue.split('').map(char => {
        const pIndex = persianDigits.indexOf(char);
        if (pIndex > -1) return pIndex.toString();
        const aIndex = arabicDigits.indexOf(char);
        if (aIndex > -1) return aIndex.toString();
        return char;
      }).join('');
      
      clean = clean.replace(/[^0-9.]/g, '');
      
      const parts = clean.split('.');
      if (parts.length > 2) {
        clean = parts[0] + '.' + parts.slice(1).join('');
      }
      
      const curr = CURRENCIES[currentCurrency];
      if (parts[1] && parts[1].length > curr.decimals) {
        clean = parts[0] + '.' + parts[1].substring(0, curr.decimals);
      }
      
      let num = parseFloat(clean) || 0;
      
      if (clean.replace('.', '').length > 15) {
        const digits = clean.replace('.', '');
        const truncated = digits.substring(0, 15);
        if (parts[1]) {
          const intLength = parts[0].length;
          const newDecimal = truncated.substring(intLength, 15);
          clean = parts[0].substring(0, Math.min(intLength, 15)) + (newDecimal ? '.' + newDecimal : '');
        } else {
          clean = truncated;
        }
        num = parseFloat(clean) || 0;
      }
      
      let formatted;
      if (currentLang === 'fa') {
        const numParts = num.toFixed(curr.decimals).split('.');
        const intPart = numParts[0];
        const decPart = numParts[1] || '';
        
        let result = '';
        let counter = 0;
        for (let i = intPart.length - 1; i >= 0; i--) {
          result = intPart[i] + result;
          counter++;
          if (counter === 3 && i > 0) {
            result = 'ØŒ' + result;
            counter = 0;
          }
        }
        
        const pDigits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
        result = result.split('').map(char => {
          if (char >= '0' && char <= '9') return pDigits[parseInt(char)];
          return char;
        }).join('');
        
        if (decPart && curr.decimals > 0) {
          const pDec = decPart.split('').map(char => 
            char >= '0' && char <= '9' ? pDigits[parseInt(char)] : char
          ).join('');
          formatted = result + '/' + pDec;
        } else {
          formatted = result;
        }
      } else {
        formatted = num.toLocaleString('en-US', {
          minimumFractionDigits: curr.decimals,
          maximumFractionDigits: curr.decimals
        });
      }
      
      if (input.value !== formatted) {
        const newLen = formatted.length;
        input.value = formatted;
        input.setSelectionRange(newLen, newLen);
      }
    }

    // ==================== AUTH ====================
    function showAuth() {
      document.getElementById('auth-page').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('auth-page').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.getElementById('username-display').textContent = currentUser?.name || 'Ú©Ø§Ø±Ø¨Ø±';
      applyLang();
      renderAll();
      checkActivation();
    }

    async function register() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass = document.getElementById('reg-password').value;
      const confirm = document.getElementById('reg-password-confirm').value;
      
      if (!name || !email || !pass) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
      }
      
      if (pass !== confirm) {
        alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†Ø¯');
        return;
      }
      
      const user = { name, email, password: pass, created: new Date().toISOString(), role: 'user' };
      await dbSave('users', user);
      
      alert('Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚! Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
      showLogin();
    }

    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const pass = document.getElementById('login-password').value;
      
      const users = await dbGetAll('users');
      const user = users.find(u => u.email === email && u.password === pass);
      
      if (user) {
        currentUser = user;
        localStorage.setItem('crm_user', JSON.stringify(user));
        showMainApp();
      } else {
        alert('Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('crm_user');
      location.reload();
    }

    function showLogin() {
      document.getElementById('login-box').style.display = 'block';
      document.getElementById('register-box').style.display = 'none';
      document.getElementById('forgot-box').style.display = 'none';
    }

    function showRegister() {
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('register-box').style.display = 'block';
      document.getElementById('forgot-box').style.display = 'none';
    }

    function showForgotPassword() {
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('register-box').style.display = 'none';
      document.getElementById('forgot-box').style.display = 'block';
    }

    function sendResetLink() {
      alert('Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ù†Ø³Ø®Ù‡ Ø¯Ù…Ùˆ)');
      showLogin();
    }

    // ==================== USER MANAGEMENT ====================
    async function renderUserList() {
      const users = await dbGetAll('users');
      const container = document.getElementById('user-list');
      
      container.innerHTML = users.map(u => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 6px;">
          <div>
            <div style="font-weight: 600;">${u.name}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${u.email} - ${u.role === 'admin' ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ú©Ø§Ø±Ø¨Ø±'}</div>
          </div>
          ${u.id !== currentUser?.id ? `<button class="btn-3d small danger" onclick="deleteUser(${u.id})">ğŸ—‘</button>` : ''}
        </div>
      `).join('') || '<div style="color: var(--text-muted); text-align: center;">Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ø¨Ø±</div>';
    }

    function showAddUserModal() {
      if (currentUser?.role !== 'admin') {
        alert('ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ø¯');
        return;
      }
      document.getElementById('add-user-modal').style.display = 'flex';
    }

    function closeAddUserModal() {
      document.getElementById('add-user-modal').style.display = 'none';
    }

    async function addNewUser() {
      const name = document.getElementById('new-user-name').value.trim();
      const email = document.getElementById('new-user-email').value.trim();
      const password = document.getElementById('new-user-password').value;
      const role = document.getElementById('new-user-role').value;
      
      if (!name || !email || !password) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
      }
      
      const users = await dbGetAll('users');
      if (users.some(u => u.email === email)) {
        alert('Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª');
        return;
      }
      
      const user = { name, email, password, role, created: new Date().toISOString() };
      await dbSave('users', user);
      
      closeAddUserModal();
      renderUserList();
      alert('Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
    }

    async function deleteUser(id) {
      if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
      await dbDelete('users', id);
      renderUserList();
    }

    // ==================== UI & NAVIGATION ====================
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('show');
    }

    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById('page-' + page).style.display = 'block';
      
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
          item.classList.add('active');
        }
      });
      
      document.getElementById('sidebar').classList.remove('open');
      document.querySelector('.sidebar-overlay').classList.remove('show');
      
      if (page === 'settings') {
        renderUserList();
      }
      
      renderAll();
    }

    function goToSettings() {
      showPage('settings');
    }

    function startClock() {
      updateClock();
      setInterval(updateClock, 1000);
    }

    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString(currentLang === 'fa' ? 'fa-IR' : 'en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });
      const dateStr = now.toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      
      document.getElementById('clock').textContent = timeStr;
      document.getElementById('date').textContent = dateStr;
    }

    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('crm_lang', lang);
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
      applyLang();
      renderAll();
    }

    function applyLang() {
      // Language translations
      const dict = {
        fa: {
          app_title: 'Ø¨Ù‡ØªØ±ÛŒÙ† Ù†Ø±Ù… Ø§ÙØ²Ø§Ø± Ù…Ø§Ù„ÛŒ Ùˆ CRM',
          menu_dashboard: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
          menu_customers: 'Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§',
          menu_operations: 'Ø¹Ù…Ù„ÛŒØ§Øª',
          menu_finance: 'Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ',
          menu_archive: 'Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ',
          menu_settings: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
          title_dashboard: 'ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯',
          title_customers: 'ğŸ‘¥ Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§',
          title_operations: 'âš™ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø¯Ù…Øª',
          title_finance: 'ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ',
          title_archive: 'ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ',
          title_settings: 'âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
          stat_customers: 'Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§',
          stat_services: 'Ø®Ø¯Ù…Ø§Øª',
          stat_operations: 'Ø¹Ù…Ù„ÛŒØ§Øª',
          stat_debt: 'Ù…Ø§Ù†Ø¯Ù‡ Ú©Ù„',
          stat_income: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
          stat_expense: 'Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ',
          stat_net: 'Ø®Ø§Ù„Øµ',
          dashboard_debtors: 'ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†',
          dashboard_activities: 'ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§',
          empty_debtors: 'Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù‡Ú©Ø§Ø±',
          empty_activity: 'Ø®Ø§Ù„ÛŒ...',
          btn_add_customer: '+ Ø§ÙØ²ÙˆØ¯Ù†',
          btn_add_service: '+ Ø§ÙØ²ÙˆØ¯Ù† Ø®Ø¯Ù…Øª',
          btn_save: 'ğŸ’¾ Ø«Ø¨Øª',
          btn_quick_add_service: '+ ØªØ¹Ø±ÛŒÙ Ø®Ø¯Ù…Øª Ø¬Ø¯ÛŒØ¯',
          btn_week_report: 'ğŸ“… Ù‡ÙØªÚ¯ÛŒ',
          btn_month_report: 'ğŸ“† Ù…Ø§Ù‡Ø§Ù†Ù‡',
          th_id: 'Ø´Ù†Ø§Ø³Ù‡',
          th_name: 'Ù†Ø§Ù…',
          th_phone: 'ØªÙ…Ø§Ø³',
          th_total: 'Ù…Ø¨Ù„Øº Ú©Ù„',
          th_remaining: 'Ù…Ø§Ù†Ø¯Ù‡',
          th_status: 'ÙˆØ¶Ø¹ÛŒØª',
          th_actions: 'Ø¹Ù…Ù„ÛŒØ§Øª',
          th_customer: 'Ù…Ø´ØªØ±ÛŒ',
          th_service: 'Ø®Ø¯Ù…Øª',
          th_date: 'ØªØ§Ø±ÛŒØ®',
          th_paid: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
          th_service_title: 'Ø¹Ù†ÙˆØ§Ù†',
          th_price: 'Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶',
          th_total_amount: 'Ù…Ø¨Ù„Øº Ú©Ù„',
          th_ops_count: 'ØªØ¹Ø¯Ø§Ø¯',
          lbl_customer: 'Ù…Ø´ØªØ±ÛŒ:',
          lbl_service: 'Ø®Ø¯Ù…Øª:',
          lbl_total: 'Ù…Ø¨Ù„Øº Ú©Ù„:',
          lbl_paid: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ:',
          lbl_pay_type: 'Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª:',
          lbl_status: 'ÙˆØ¶Ø¹ÛŒØª:',
          lbl_desc: 'ØªÙˆØ¶ÛŒØ­Ø§Øª:',
          op_new: 'ğŸ“ Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯',
          activation_locked: 'Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„',
          activation_active: 'Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª',
          activation_desc: 'Ù¾Ø³ Ø§Ø² Û±Û° Ø¹Ù…Ù„ÛŒØ§Øª Ø®Ø¯Ù…ØªØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø±ÛŒØ¯.',
          activation_contact: 'Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ØŒ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø²ÛŒØ± Ù¾ÛŒØ§Ù… Ø¯Ù‡ÛŒØ¯:',
          btn_activate: 'ğŸ”‘ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ',
          license_type: 'Ù†ÙˆØ¹ Ù„Ø§ÛŒØ³Ù†Ø³:',
          license_expire: 'Ø§Ù†Ù‚Ø¶Ø§:',
          settings_business_info: 'ğŸ¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±',
          lbl_biz_name: 'Ù†Ø§Ù… Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±:',
          lbl_biz_phone: 'ØªÙ„ÙÙ†:',
          lbl_biz_address: 'Ø¢Ø¯Ø±Ø³:',
          btn_save_business: 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',
          settings_currency: 'ğŸ’± ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„',
          current_currency: 'ÙˆØ§Ø­Ø¯ ÙØ¹Ù„ÛŒ:',
          settings_user_mgmt: 'ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',
          user_mgmt_desc: 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯. ØªÙˆØ¬Ù‡: ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ØªØ¹Ø±ÛŒÙ Ú©Ù†Ø¯.',
          btn_add_user: '+ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±',
          settings_backup: 'ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†',
          btn_export: 'ğŸ“¥ Export',
          btn_import: 'ğŸ“¤ Import',
          settings_reset: 'ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡',
          reset_warning: 'Ù‡Ø´Ø¯Ø§Ø±: ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª!',
          btn_reset: 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†',
          db_desc: 'Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ MySQL/PostgreSQL/MongoDB ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:',
          btn_save_db: 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª DB',
          btn_test_db: 'ğŸ”— ØªØ³Øª Ø§ØªØµØ§Ù„',
          ph_search_customer: 'Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ...',
          ph_search_service: 'Ø¬Ø³ØªØ¬ÙˆÛŒ Ø®Ø¯Ù…Øª...',
          ph_search: 'Ø¬Ø³ØªØ¬Ùˆ...'
        },
        en: {
          app_title: 'Best Financial CRM Software',
          menu_dashboard: 'Dashboard',
          menu_customers: 'Customers',
          menu_operations: 'Operations',
          menu_finance: 'Finance',
          menu_archive: 'Archive',
          menu_settings: 'Settings',
          title_dashboard: 'ğŸ“Š Dashboard',
          title_customers: 'ğŸ‘¥ Customers',
          title_operations: 'âš™ï¸ Operations',
          title_finance: 'ğŸ’° Finance',
          title_archive: 'ğŸ“¦ Archive',
          title_settings: 'âš™ï¸ Settings',
          stat_customers: 'Customers',
          stat_services: 'Services',
          stat_operations: 'Operations',
          stat_debt: 'Total Debt',
          stat_income: 'Income',
          stat_expense: 'Expense',
          stat_net: 'Net',
          dashboard_debtors: 'ğŸ”´ Debtors',
          dashboard_activities: 'ğŸ“‹ Recent Activities',
          empty_debtors: 'No debtors',
          empty_activity: 'Empty...',
          btn_add_customer: '+ Add',
          btn_add_service: '+ Add Service',
          btn_save: 'ğŸ’¾ Save',
          btn_quick_add_service: '+ Quick Add Service',
          btn_week_report: 'ğŸ“… Weekly',
          btn_month_report: 'ğŸ“† Monthly',
          th_id: 'ID',
          th_name: 'Name',
          th_phone: 'Phone',
          th_total: 'Total Amount',
          th_remaining: 'Remaining',
          th_status: 'Status',
          th_actions: 'Actions',
          th_customer: 'Customer',
          th_service: 'Service',
          th_date: 'Date',
          th_paid: 'Paid',
          th_service_title: 'Title',
          th_price: 'Default Price',
          th_total_amount: 'Total Amount',
          th_ops_count: 'Count',
          lbl_customer: 'Customer:',
          lbl_service: 'Service:',
          lbl_total: 'Total Amount:',
          lbl_paid: 'Paid:',
          lbl_pay_type: 'Payment Method:',
          lbl_status: 'Status:',
          lbl_desc: 'Description:',
          op_new: 'ğŸ“ New Record',
          activation_locked: 'Software Inactive',
          activation_active: 'Software Active',
          activation_desc: 'After 10 service operations, activation code is required.',
          activation_contact: 'To receive code, contact:',
          btn_activate: 'ğŸ”‘ Activate',
          license_type: 'License Type:',
          license_expire: 'Expires:',
          settings_business_info: 'ğŸ¢ Business Info',
          lbl_biz_name: 'Business Name:',
          lbl_biz_phone: 'Phone:',
          lbl_biz_address: 'Address:',
          btn_save_business: 'ğŸ’¾ Save Info',
          settings_currency: 'ğŸ’± Currency',
          current_currency: 'Current:',
          settings_user_mgmt: 'ğŸ‘¥ User Management',
          user_mgmt_desc: 'Manage system users. Note: Only admin can add new users.',
          btn_add_user: '+ Add User',
          settings_backup: 'ğŸ’¾ Backup',
          btn_export: 'ğŸ“¥ Export',
          btn_import: 'ğŸ“¤ Import',
          settings_reset: 'ğŸ—‘ï¸ Reset All',
          reset_warning: 'Warning: Irreversible!',
          btn_reset: 'Reset',
          db_desc: 'Enter settings to connect to MySQL/PostgreSQL/MongoDB:',
          btn_save_db: 'ğŸ’¾ Save DB Settings',
          btn_test_db: 'ğŸ”— Test Connection',
          ph_search_customer: 'Search customers...',
          ph_search_service: 'Search services...',
          ph_search: 'Search...'
        }
      };
      
      const t = dict[currentLang];
      
      // Update all elements with data-key
      document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        if (t[key]) el.textContent = t[key];
      });
      
      // Update placeholders
      document.querySelectorAll('[data-key-placeholder]').forEach(el => {
        const key = el.getAttribute('data-key-placeholder');
        if (t[key]) el.placeholder = t[key];
      });
      
      // Update app title
      document.getElementById('app-title').textContent = t.app_title;
      
      // Update document direction
      document.documentElement.dir = currentLang === 'fa' ? 'rtl' : 'ltr';
    }

    // ==================== CUSTOMERS ====================
    async function addCustomer() {
      const name = prompt(currentLang === 'fa' ? 'Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ:' : 'Customer name:');
      if (!name) return;
      
      const phone = prompt(currentLang === 'fa' ? 'Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:' : 'Phone:') || '';
      const email = prompt(currentLang === 'fa' ? 'Ø§ÛŒÙ…ÛŒÙ„:' : 'Email:') || '';
      
      const exists = customers.some(c => 
        c.name.toLowerCase() === name.toLowerCase() || 
        (email && c.email === email)
      );
      
      if (exists) {
        alert(currentLang === 'fa' ? 'Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù… ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡' : 'Customer already exists');
        return;
      }
      
      const customer = {
        name,
        phone,
        email,
        address: '',
        note: '',
        created: new Date().toISOString()
      };
      
      const id = await dbSave('customers', customer);
      customer.id = id;
      customers.push(customer);
      
      addActivity(currentLang === 'fa' ? `Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯: ${name}` : `New customer: ${name}`);
      renderCustomers();
    }

    async function deleteCustomer(id) {
      if (!confirm(currentLang === 'fa' ? 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ' : 'Delete this customer?')) return;
      
      await dbDelete('customers', id);
      
      const ops = operations.filter(o => o.customerId === id);
      for (let op of ops) await dbDelete('operations', op.id);
      
      const fins = finance.filter(f => f.customerId === id);
      for (let f of fins) await dbDelete('finance', f.id);
      
      const stgs = stages.filter(s => s.customerId === id);
      for (let s of stgs) await dbDelete('stages', s.id);
      
      customers = customers.filter(c => c.id !== id);
      operations = operations.filter(o => o.customerId !== id);
      finance = finance.filter(f => f.customerId !== id);
      stages = stages.filter(s => s.customerId !== id);
      
      renderAll();
    }

    function editCustomer(id) {
      const c = customers.find(x => x.id === id);
      if (!c) return;
      
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = c.name;
      document.getElementById('edit-phone').value = c.phone || '';
      document.getElementById('edit-email').value = c.email || '';
      document.getElementById('edit-address').value = c.address || '';
      document.getElementById('edit-note').value = c.note || '';
      
      document.getElementById('edit-modal').style.display = 'flex';
    }

    async function saveEdit() {
      const id = Number(document.getElementById('edit-id').value);
      const c = customers.find(x => x.id === id);
      if (!c) return;
      
      c.name = document.getElementById('edit-name').value;
      c.phone = document.getElementById('edit-phone').value;
      c.email = document.getElementById('edit-email').value;
      c.address = document.getElementById('edit-address').value;
      c.note = document.getElementById('edit-note').value;
      
      await dbSave('customers', c);
      closeEditModal();
      renderAll();
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
    }

    // ==================== SERVICES ====================
    async function quickAddService() {
      const title = prompt(currentLang === 'fa' ? 'Ø¹Ù†ÙˆØ§Ù† Ø®Ø¯Ù…Øª:' : 'Service title:');
      if (!title) return;
      
      const priceInput = prompt(currentLang === 'fa' ? 'Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):' : 'Default price (optional):') || '0';
      const price = parseNumber(priceInput);
      
      const service = {
        title,
        price,
        desc: '',
        created: new Date().toISOString()
      };
      
      const id = await dbSave('services', service);
      service.id = id;
      services.push(service);
      
      fillSelectors();
      alert(currentLang === 'fa' ? 'Ø®Ø¯Ù…Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯' : 'Service added');
    }

    function autoFillPrice() {
      const sid = Number(document.getElementById('op-service').value);
      const s = services.find(x => x.id === sid);
      if (s && s.price > 0) {
        document.getElementById('op-total').value = formatNumber(s.price, false);
      }
    }

    // ==================== OPERATIONS ====================
    async function saveOperation() {
      if (!checkActivation()) return;
      
      const custId = Number(document.getElementById('op-customer').value);
      const servId = Number(document.getElementById('op-service').value);
      const total = parseNumber(document.getElementById('op-total').value);
      const paid = parseNumber(document.getElementById('op-paid').value);
      const payType = document.getElementById('op-pay-type').value;
      const status = document.getElementById('op-status').value;
      const desc = document.getElementById('op-desc').value || '';
      
      if (!custId || !servId || total <= 0) {
        alert(currentLang === 'fa' ? 'Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯' : 'Please fill all fields');
        return;
      }
      
      const remaining = Math.max(total - paid, 0);
      
      const newOp = {
        customerId: custId,
        serviceId: servId,
        total,
        paid,
        remaining,
        payType,
        status,
        desc,
        datetime: new Date().toISOString()
      };
      
      const opId = await dbSave('operations', newOp);
      newOp.id = opId;
      operations.push(newOp);
      
      if (paid > 0) {
        const finEntry = {
          datetime: newOp.datetime,
          customerId: custId,
          operationId: opId,
          type: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
          payType,
          amount: paid
        };
        const finId = await dbSave('finance', finEntry);
        finEntry.id = finId;
        finance.push(finEntry);
      }
      
      document.getElementById('op-total').value = '';
      document.getElementById('op-paid').value = '';
      document.getElementById('op-desc').value = '';
      
      addActivity(currentLang === 'fa' ? `Ø¹Ù…Ù„ÛŒØ§Øª Ø¬Ø¯ÛŒØ¯: ${formatNumber(total)}` : `New operation: ${formatNumber(total)}`);
      renderAll();
    }

    async function deleteOperation(id) {
      if (!confirm(currentLang === 'fa' ? 'Ø­Ø°Ù Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§ØªØŸ' : 'Delete this operation?')) return;
      
      await dbDelete('operations', id);
      
      const finToDelete = finance.filter(f => f.operationId === id);
      for (let f of finToDelete) await dbDelete('finance', f.id);
      finance = finance.filter(f => f.operationId !== id);
      
      operations = operations.filter(o => o.id !== id);
      renderAll();
    }

    function getStatusIcon(status) {
      const icons = {
        'pending': 'ğŸŸ ',
        'done': 'ğŸ”µ',
        'archive': 'âš«'
      };
      return icons[status] || 'âšª';
    }

    function getStatusClass(status) {
      const classes = {
        'pending': 'status-pending',
        'done': 'status-done',
        'archive': 'status-archive'
      };
      return classes[status] || 'status-pending';
    }

    function getStatusText(status) {
      const texts = {
        'pending': currentLang === 'fa' ? 'Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…' : 'Pending',
        'done': currentLang === 'fa' ? 'Ø§ØªÙ…Ø§Ù…' : 'Done',
        'archive': currentLang === 'fa' ? 'Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ' : 'Archived'
      };
      return texts[status] || status;
    }

    async function toggleOperationStatus(id) {
      const op = operations.find(o => o.id === id);
      if (!op) return;
      
      const statuses = ['pending', 'done', 'archive'];
      const currentIndex = statuses.indexOf(op.status || 'pending');
      const nextIndex = (currentIndex + 1) % statuses.length;
      op.status = statuses[nextIndex];
      
      await dbSave('operations', op);
      renderOperations();
    }

    // ==================== PAYMENTS & STAGES ====================
    async function addPayment() {
      if (!currentCustomerId) return;
      
      const payType = document.getElementById('pay-type').value;
      const amount = parseNumber(document.getElementById('pay-amount').value);
      const stageId = document.getElementById('pay-for-stage').value;
      
      if (amount <= 0) {
        alert(currentLang === 'fa' ? 'Ù…Ø¨Ù„Øº Ù†Ø§Ù…Ø¹ØªØ¨Ø±' : 'Invalid amount');
        return;
      }
      
      let custOps = operations.filter(o => o.customerId === currentCustomerId && o.remaining > 0);
      custOps.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
      
      let remainingPayment = amount;
      
      for (let op of custOps) {
        if (remainingPayment <= 0) break;
        
        if (remainingPayment >= op.remaining) {
          remainingPayment -= op.remaining;
          op.paid += op.remaining;
          op.remaining = 0;
        } else {
          op.paid += remainingPayment;
          op.remaining -= remainingPayment;
          remainingPayment = 0;
        }
        
        await dbSave('operations', op);
      }
      
      const finEntry = {
        datetime: new Date().toISOString(),
        customerId: currentCustomerId,
        type: 'Ø¯Ø±ÛŒØ§ÙØªÛŒ',
        payType,
        amount: amount,
        stageId: stageId || null,
        note: 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ù¾Ø±ÙˆÙØ§ÛŒÙ„'
      };
      
      await dbSave('finance', finEntry);
      finance.push(finEntry);
      
      document.getElementById('pay-amount').value = '';
      
      addActivity(currentLang === 'fa' ? `Ù¾Ø±Ø¯Ø§Ø®Øª ${formatNumber(amount)} Ø«Ø¨Øª Ø´Ø¯` : `Payment ${formatNumber(amount)} registered`);
      openCustomerModal(currentCustomerId);
      renderAll();
    }

    async function addStage() {
      if (!currentCustomerId) return;
      
      const title = document.getElementById('stage-title').value.trim();
      const amount = parseNumber(document.getElementById('stage-amount').value);
      const desc = document.getElementById('stage-desc').value.trim();
      
      if (!title) {
        alert(currentLang === 'fa' ? 'Ø¹Ù†ÙˆØ§Ù† Ù…Ø±Ø­Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯' : 'Enter stage title');
        return;
      }
      
      const stage = {
        customerId: currentCustomerId,
        title,
        amount,
        desc,
        status: 'pending',
        datetime: new Date().toISOString()
      };
      
      const id = await dbSave('stages', stage);
      stage.id = id;
      stages.push(stage);
      
      document.getElementById('stage-title').value = '';
      document.getElementById('stage-amount').value = '';
      document.getElementById('stage-desc').value = '';
      
      renderStagesList(currentCustomerId);
      updateStageSelector(currentCustomerId);
      addActivity(currentLang === 'fa' ? 'Ù…Ø±Ø­Ù„Ù‡ Ú©Ø§Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯' : 'New stage added');
    }

    async function deleteStage(id) {
      if (!confirm(currentLang === 'fa' ? 'Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ØŸ' : 'Delete this stage?')) return;
      
      await dbDelete('stages', id);
      stages = stages.filter(s => s.id !== id);
      
      renderStagesList(currentCustomerId);
      updateStageSelector(currentCustomerId);
    }

    async function toggleStageStatus(id) {
      const stage = stages.find(s => s.id === id);
      if (!stage) return;
      
      stage.status = stage.status === 'done' ? 'pending' : 'done';
      await dbSave('stages', stage);
      renderStagesList(currentCustomerId);
    }

    function renderStagesList(custId) {
      const container = document.getElementById('stages-list');
      const custStages = stages.filter(s => s.customerId === custId);
      custStages.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      
      container.innerHTML = custStages.map(s => `
        <div class="stage-item">
          <div class="stage-content">
            <div class="stage-text">${s.title}</div>
            <div class="stage-meta">
              ${formatDateTime(new Date(s.datetime))}
              ${s.amount > 0 ? '| ' + formatNumber(s.amount) : ''}
              ${s.desc ? '| ' + s.desc : ''}
            </div>
          </div>
          <div style="display:flex; gap:6px;">
            ${s.amount > 0 ? `<span class="stage-amount">${formatNumber(s.amount)}</span>` : ''}
            <button class="btn-3d small ${s.status === 'done' ? 'success' : 'secondary'}" 
                    onclick="toggleStageStatus(${s.id})" style="padding:4px 8px; font-size:10px;">
              ${s.status === 'done' ? 'âœ“' : 'â—‹'}
            </button>
            <button class="btn-3d small danger" onclick="deleteStage(${s.id})" style="padding:4px 8px; font-size:10px;">ğŸ—‘</button>
          </div>
        </div>
      `).join('');
    }

    function updateStageSelector(custId) {
      const sel = document.getElementById('pay-for-stage');
      const custStages = stages.filter(s => s.customerId === custId && s.status !== 'done');
      
      sel.innerHTML = '<option value="">-- ' + (currentLang === 'fa' ? 'Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø±Ø­Ù„Ù‡' : 'Select stage') + ' --</option>' +
        custStages.map(s => `<option value="${s.id}">${s.title} ${s.amount > 0 ? '(' + formatNumber(s.amount, false) + ')' : ''}</option>`).join('');
    }

    // ==================== MODALS ====================
    async function openCustomerModal(id) {
      const c = customers.find(x => x.id === id);
      if (!c) return;
      
      currentCustomerId = id;
      
      const custOps = operations.filter(o => o.customerId === id);
      const totalRemaining = custOps.reduce((s, o) => s + o.remaining, 0);
      const totalPaid = custOps.reduce((s, o) => s + o.paid, 0);
      const totalAmount = custOps.reduce((s, o) => s + o.total, 0);
      
      document.getElementById('modal-title').textContent = `ğŸ‘¤ ${c.name}`;
      
      document.getElementById('customer-info').innerHTML = `
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'Ù†Ø§Ù…' : 'Name'}</div>
          <div class="info-value">${c.name}</div>
        </div>
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'ØªÙ…Ø§Ø³' : 'Phone'}</div>
          <div class="info-value">${c.phone || '---'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'Ø§ÛŒÙ…ÛŒÙ„' : 'Email'}</div>
          <div class="info-value">${c.email || '---'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø¨Ù„Øº Ú©Ù„' : 'Total'}</div>
          <div class="info-value amount-total">${formatNumber(totalAmount)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Paid'}</div>
          <div class="info-value paid">${formatNumber(totalPaid)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø§Ù†Ø¯Ù‡' : 'Remaining'}</div>
          <div class="info-value ${totalRemaining > 0 ? 'debt' : 'paid'}">${formatNumber(totalRemaining)}</div>
        </div>
      `;
      
      const custFin = finance.filter(f => f.customerId === id && f.type === 'Ø¯Ø±ÛŒØ§ÙØªÛŒ');
      custFin.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      
      document.getElementById('payments-list').innerHTML = custFin.map(f => `
        <div class="payment-item">
          <div class="stage-content">
            <div class="stage-text">${formatNumber(f.amount)}</div>
            <div class="stage-meta">${formatDateTime(new Date(f.datetime))}</div>
          </div>
          <span class="pay-pill ${getPayClass(f.payType)}">${f.payType}</span>
        </div>
      `).join('');
      
      renderStagesList(id);
      updateStageSelector(id);
      
      document.getElementById('customer-modal').style.display = 'flex';
    }

    function closeCustomerModal() {
      document.getElementById('customer-modal').style.display = 'none';
      currentCustomerId = null;
    }

    function showCustomerStagesModal() {
      if (!currentCustomerId) return;
      
      const c = customers.find(x => x.id === currentCustomerId);
      const custStages = stages.filter(s => s.customerId === currentCustomerId);
      custStages.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      
      const content = document.getElementById('stages-modal-content');
      content.innerHTML = `
        <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
          <strong style="color: var(--primary);">${c.name}</strong>
          <div style="color: var(--text-muted); font-size: 12px; margin-top: 4px;">
            ${currentLang === 'fa' ? 'ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ø­Ù„:' : 'Stages:'} ${custStages.length}
          </div>
        </div>
        ${custStages.length === 0 ? '<div style="text-align:center; color:var(--text-muted); padding:20px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø­Ù„Ù‡' : 'No stages') + '</div>' : ''}
        ${custStages.map(s => `
          <div class="stage-item" style="margin-bottom: 8px;">
            <div class="stage-content">
              <div class="stage-text">${s.title}</div>
              <div class="stage-meta">
                ${formatDateTime(new Date(s.datetime))}
                ${s.amount > 0 ? '| ' + formatNumber(s.amount) : ''}
                ${s.desc ? '| ' + s.desc : ''}
              </div>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <span class="status-pill ${s.status === 'done' ? 'status-done' : 'status-pending'}">
                ${s.status === 'done' ? (currentLang === 'fa' ? 'âœ“ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡' : 'âœ“ Done') : (currentLang === 'fa' ? 'â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : 'â³ Pending')}
              </span>
              ${s.amount > 0 ? `<span class="stage-amount">${formatNumber(s.amount)}</span>` : ''}
            </div>
          </div>
        `).join('')}
      `;
      
      document.getElementById('stages-modal').style.display = 'flex';
    }

    function closeStagesModal() {
      document.getElementById('stages-modal').style.display = 'none';
    }

    function showFinanceDetails(customerId) {
      const c = customers.find(x => x.id === customerId);
      const custFin = finance.filter(f => f.customerId === customerId);
      const custOps = operations.filter(o => o.customerId === customerId);
      
      const totalPaid = custFin.reduce((s, f) => s + f.amount, 0);
      const totalOps = custOps.reduce((s, o) => s + o.total, 0);
      const totalRemaining = custOps.reduce((s, o) => s + o.remaining, 0);
      
      document.getElementById('finance-modal-content').innerHTML = `
        <div class="customer-info-compact" style="grid-template-columns: 1fr; margin-bottom: 20px;">
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Customer'}</div>
            <div class="info-value" style="font-size: 16px; color: var(--primary);">${c ? c.name : '-'}</div>
          </div>
        </div>
        
        <div class="customer-info-compact" style="margin-bottom: 20px;">
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø¨Ù„Øº Ú©Ù„ Ø¹Ù…Ù„ÛŒØ§Øª' : 'Total Operations'}</div>
            <div class="info-value amount-total">${formatNumber(totalOps)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ' : 'Total Paid'}</div>
            <div class="info-value paid">${formatNumber(totalPaid)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø§Ù†Ø¯Ù‡' : 'Remaining'}</div>
            <div class="info-value ${totalRemaining > 0 ? 'debt' : 'paid'}">${formatNumber(totalRemaining)}</div>
          </div>
        </div>
        
        <h4 style="color: var(--primary); margin-bottom: 12px;">${currentLang === 'fa' ? 'ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§' : 'ğŸ“‹ Payment History'}</h4>
        ${custFin.length === 0 ? '<div style="color:var(--text-muted); text-align:center; padding:20px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù¾Ø±Ø¯Ø§Ø®Øª' : 'No payments') + '</div>' : ''}
        ${custFin.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).map(f => `
          <div class="payment-item">
            <div class="stage-content">
              <div class="stage-text">${formatNumber(f.amount)}</div>
              <div class="stage-meta">${formatDateTime(new Date(f.datetime))} | ${f.payType}</div>
            </div>
            <span class="pay-pill ${getPayClass(f.payType)}">${f.payType}</span>
          </div>
        `).join('')}
        
        <h4 style="color: var(--primary); margin: 20px 0 12px;">${currentLang === 'fa' ? 'ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ú©Ø§Ø±' : 'ğŸ“‹ Work Stages'}</h4>
        ${stages.filter(s => s.customerId === customerId).length === 0 ? '<div style="color:var(--text-muted); text-align:center; padding:20px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø­Ù„Ù‡' : 'No stages') + '</div>' : ''}
        ${stages.filter(s => s.customerId === customerId).sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).map(s => `
          <div class="stage-item">
            <div class="stage-content">
              <div class="stage-text">${s.title}</div>
              <div class="stage-meta">${formatDateTime(new Date(s.datetime))}${s.amount > 0 ? ' | ' + formatNumber(s.amount) : ''}</div>
            </div>
            <span class="status-pill ${s.status === 'done' ? 'status-done' : 'status-pending'}">
              ${s.status === 'done' ? 'âœ“' : 'â—‹'}
            </span>
          </div>
        `).join('')}
      `;
      
      document.getElementById('finance-modal').style.display = 'flex';
    }

    function closeFinanceModal() {
      document.getElementById('finance-modal').style.display = 'none';
    }

    function showArchiveDetails(opId) {
      const op = operations.find(o => o.id === opId);
      if (!op) return;
      
      const c = customers.find(x => x.id === op.customerId);
      const s = services.find(x => x.id === op.serviceId);
      const opStages = stages.filter(st => st.customerId === op.customerId);
      const opPayments = finance.filter(f => f.operationId === opId || (f.customerId === op.customerId && f.type === 'Ø¯Ø±ÛŒØ§ÙØªÛŒ'));
      
      document.getElementById('archive-detail-content').innerHTML = `
        <div class="customer-info-compact" style="margin-bottom: 20px;">
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø´ØªØ±ÛŒ' : 'Customer'}</div>
            <div class="info-value">${c ? c.name : '-'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ø®Ø¯Ù…Øª' : 'Service'}</div>
            <div class="info-value">${s ? s.title : '-'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'ØªØ§Ø±ÛŒØ®' : 'Date'}</div>
            <div class="info-value">${formatDateTime(new Date(op.datetime))}</div>
          </div>
        </div>
        
        <div class="customer-info-compact" style="margin-bottom: 20px;">
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø¨Ù„Øº Ú©Ù„' : 'Total'}</div>
            <div class="info-value amount-total">${formatNumber(op.total)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Paid'}</div>
            <div class="info-value paid">${formatNumber(op.paid)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">${currentLang === 'fa' ? 'Ù…Ø§Ù†Ø¯Ù‡' : 'Remaining'}</div>
            <div class="info-value ${op.remaining > 0 ? 'debt' : 'paid'}">${formatNumber(op.remaining)}</div>
          </div>
        </div>
        
        <h4 style="color: var(--primary); margin-bottom: 12px;">${currentLang === 'fa' ? 'ğŸ“‹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§' : 'ğŸ“‹ Payments'}</h4>
        ${opPayments.length === 0 ? '<div style="color:var(--text-muted); text-align:center; padding:10px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù¾Ø±Ø¯Ø§Ø®Øª' : 'No payments') + '</div>' : ''}
        ${opPayments.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).map(f => `
          <div class="payment-item">
            <div class="stage-content">
              <div class="stage-text">${formatNumber(f.amount)}</div>
              <div class="stage-meta">${formatDateTime(new Date(f.datetime))}</div>
            </div>
            <span class="pay-pill ${getPayClass(f.payType)}">${f.payType}</span>
          </div>
        `).join('')}
        
        <h4 style="color: var(--primary); margin: 20px 0 12px;">${currentLang === 'fa' ? 'ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ú©Ø§Ø±' : 'ğŸ“‹ Work Stages'}</h4>
        ${opStages.length === 0 ? '<div style="color:var(--text-muted); text-align:center; padding:10px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø­Ù„Ù‡' : 'No stages') + '</div>' : ''}
        ${opStages.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)).map(st => `
          <div class="stage-item">
            <div class="stage-content">
              <div class="stage-text">${st.title}</div>
              <div class="stage-meta">${formatDateTime(new Date(st.datetime))}${st.amount > 0 ? ' | ' + formatNumber(st.amount) : ''}</div>
            </div>
            <span class="status-pill ${st.status === 'done' ? 'status-done' : 'status-pending'}">
              ${st.status === 'done' ? 'âœ“' : 'â—‹'}
            </span>
          </div>
        `).join('')}
        
        ${op.desc ? `
        <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <div style="color: var(--primary); font-size: 12px; margin-bottom: 4px;">${currentLang === 'fa' ? 'ØªÙˆØ¶ÛŒØ­Ø§Øª:' : 'Description:'}</div>
          <div style="color: var(--text);">${op.desc}</div>
        </div>
        ` : ''}
      `;
      
      document.getElementById('archive-detail-modal').style.display = 'flex';
    }

    function closeArchiveDetailModal() {
      document.getElementById('archive-detail-modal').style.display = 'none';
    }

    function getPayClass(type) {
      if (type.includes('Ú©Ø§Ø±Øª')) return 'pay-card';
      if (type.includes('Ù†Ù‚Ø¯')) return 'pay-cash';
      if (type.includes('Ø§Ø±Ø²')) return 'pay-crypto';
      if (type.includes('Ú†Ú©')) return 'pay-check';
      return 'pay-bank';
    }

    function printProfile() {
      window.print();
    }

    // ==================== RENDERERS ====================
    function renderAll() {
      renderCustomers();
      renderOperations();
      renderFinance();
      renderArchive();
      renderDashboard();
      fillSelectors();
      updateActivationUI(isLicenseValid(), operations.length);
    }

    function renderCustomers() {
      const tbody = document.querySelector('#customers-table tbody');
      if (!tbody) return;
      
      tbody.innerHTML = customers.map(c => {
        const custOps = operations.filter(o => o.customerId === c.id);
        const total = custOps.reduce((s, o) => s + o.total, 0);
        const remaining = custOps.reduce((s, o) => s + o.remaining, 0);
        const isDebt = remaining > 0;
        
        return `
          <tr>
            <td>${c.id}</td>
            <td>${c.name}</td>
            <td>${c.phone || '-'}</td>
            <td class="amount-total">${formatNumber(total)}</td>
            <td class="amount-remaining">${formatNumber(remaining)}</td>
            <td><span class="status-pill ${isDebt ? 'status-debt' : 'status-ok'}">
              ${isDebt ? (currentLang === 'fa' ? 'Ø¨Ø¯Ù‡Ú©Ø§Ø±' : 'Debtor') : (currentLang === 'fa' ? 'ØªØ³ÙˆÛŒÙ‡' : 'Paid')}
            </span></td>
            <td>
              <button class="btn-3d small secondary" onclick="openCustomerModal(${c.id})">${currentLang === 'fa' ? 'ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯Ù‡' : 'ğŸ‘ View'}</button>
              <button class="btn-3d small info" onclick="editCustomer(${c.id})">${currentLang === 'fa' ? 'âœ ÙˆÛŒØ±Ø§ÛŒØ´' : 'âœ Edit'}</button>
              <button class="btn-3d small danger" onclick="deleteCustomer(${c.id})">${currentLang === 'fa' ? 'ğŸ—‘ Ø­Ø°Ù' : 'ğŸ—‘ Delete'}</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderOperations() {
      const tbody = document.querySelector('#operations-table tbody');
      if (!tbody) return;
      
      const sorted = [...operations].filter(o => o.status !== 'archive').sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      
      tbody.innerHTML = sorted.map(o => {
        const c = customers.find(x => x.id === o.customerId);
        const s = services.find(x => x.id === o.serviceId);
        const status = o.status || 'pending';
        
        return `
          <tr>
            <td>${formatDateTime(new Date(o.datetime))}</td>
            <td>${c ? c.name : '-'}</td>
            <td>${s ? s.title : '-'}</td>
            <td class="amount-total">${formatNumber(o.total)}</td>
            <td class="amount-paid">${formatNumber(o.paid)}</td>
            <td class="amount-remaining">${formatNumber(o.remaining)}</td>
            <td>
              <span class="status-pill ${getStatusClass(status)}" onclick="toggleOperationStatus(${o.id})" style="cursor: pointer;">
                ${getStatusIcon(status)} ${getStatusText(status)}
              </span>
            </td>
            <td>
              <button class="btn-3d small danger" onclick="deleteOperation(${o.id})">${currentLang === 'fa' ? 'ğŸ—‘ Ø­Ø°Ù' : 'ğŸ—‘ Delete'}</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderFinance() {
      const tbody = document.querySelector('#finance-table tbody');
      if (!tbody) return;
      
      // Group by customer
      const customerTotals = {};
      customers.forEach(c => {
        const custOps = operations.filter(o => o.customerId === c.id);
        const total = custOps.reduce((s, o) => s + o.total, 0);
        if (total > 0) {
          customerTotals[c.id] = {
            customer: c,
            total: total
          };
        }
      });
      
      tbody.innerHTML = Object.values(customerTotals).map(ct => `
        <tr>
          <td>${ct.customer.name}</td>
          <td class="amount-total">${formatNumber(ct.total)}</td>
          <td>
            <button class="btn-3d small info" onclick="showFinanceDetails(${ct.customer.id})">${currentLang === 'fa' ? 'ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²ÛŒÛŒØ§Øª' : 'ğŸ‘ View Details'}</button>
          </td>
        </tr>
      `).join('');
      
      const income = finance.filter(f => f.type === 'Ø¯Ø±ÛŒØ§ÙØªÛŒ').reduce((s, f) => s + f.amount, 0);
      const expense = finance.filter(f => f.type === 'Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ').reduce((s, f) => s + f.amount, 0);
      
      document.getElementById('stat-income').textContent = formatNumber(income, false);
      document.getElementById('stat-expense').textContent = formatNumber(expense, false);
      document.getElementById('stat-net').textContent = formatNumber(income - expense, false);
    }

    function renderArchive() {
      const tbody = document.querySelector('#archive-table tbody');
      if (!tbody) return;
      
      const archived = operations.filter(o => o.status === 'archive').sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
      
      tbody.innerHTML = archived.map(o => {
        const c = customers.find(x => x.id === o.customerId);
        const s = services.find(x => x.id === o.serviceId);
        
        return `
          <tr>
            <td>${formatDateTime(new Date(o.datetime))}</td>
            <td>${c ? c.name : '-'}</td>
            <td>${s ? s.title : '-'}</td>
            <td class="amount-total">${formatNumber(o.total)}</td>
            <td><span class="status-pill status-archive">âš« ${currentLang === 'fa' ? 'Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ' : 'Archived'}</span></td>
            <td>
              <button class="btn-3d small info" onclick="showArchiveDetails(${o.id})">${currentLang === 'fa' ? 'ğŸ‘ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²ÛŒÛŒØ§Øª' : 'ğŸ‘ View Details'}</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderDashboard() {
      document.getElementById('stat-customers').textContent = customers.length;
      document.getElementById('stat-services').textContent = services.length;
      document.getElementById('stat-operations').textContent = operations.length;
      
      const totalDebt = customers.reduce((s, c) => {
        const custOps = operations.filter(o => o.customerId === c.id);
        return s + custOps.reduce((sum, o) => sum + o.remaining, 0);
      }, 0);
      
      document.getElementById('stat-debt').textContent = formatNumber(totalDebt, false);
      
      // Compact debtors list
      const debtorsContainer = document.getElementById('dashboard-debtors-list');
      const debtors = customers.map(c => {
        const custOps = operations.filter(o => o.customerId === c.id);
        const remaining = custOps.reduce((s, o) => s + o.remaining, 0);
        return { c, remaining };
      }).filter(x => x.remaining > 0).sort((a, b) => b.remaining - a.remaining).slice(0, 5); // Show only top 5
      
      if (debtors.length === 0) {
        debtorsContainer.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ù‡Ú©Ø§Ø±' : 'No debtors') + '</div>';
      } else {
        debtorsContainer.innerHTML = debtors.map(d => `
          <div class="debtor-item">
            <span class="debtor-name">${d.c.name}</span>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span class="debtor-amount">${formatNumber(d.remaining)}</span>
              <button class="btn-3d small info" onclick="openCustomerModal(${d.c.id})">${currentLang === 'fa' ? 'Ø¬Ø²ÛŒÛŒØ§Øª' : 'Details'}</button>
            </div>
          </div>
        `).join('');
      }
    }

    function fillSelectors() {
      const custSel = document.getElementById('op-customer');
      const servSel = document.getElementById('op-service');
      
      if (custSel) {
        custSel.innerHTML = customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('') || '<option value="">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø´ØªØ±ÛŒ' : 'No customers') + '</option>';
      }
      
      if (servSel) {
        servSel.innerHTML = services.map(s => `<option value="${s.id}">${s.title}</option>`).join('') || '<option value="">' + (currentLang === 'fa' ? 'Ø¨Ø¯ÙˆÙ† Ø®Ø¯Ù…Øª' : 'No services') + '</option>';
      }
    }

    function setCurrency(curr) {
      currentCurrency = curr;
      localStorage.setItem('crm_currency', curr);
      
      document.querySelectorAll('.currency-option').forEach(el => el.classList.remove('active'));
      const currEl = document.querySelector(`.currency-option[onclick="setCurrency('${curr}')"]`);
      if (currEl) currEl.classList.add('active');
      
      const names = { IRR: currentLang === 'fa' ? 'ØªÙˆÙ…Ø§Ù†' : 'Toman', USD: 'USD', EUR: 'EUR', GBP: 'GBP', BTC: 'BTC' };
      document.getElementById('current-currency').textContent = names[curr] || curr;
      
      renderAll();
    }

    // ==================== DATABASE CONNECTION ====================
    function saveDBConfig() {
      const config = {
        host: document.getElementById('db-host').value,
        port: document.getElementById('db-port').value,
        database: document.getElementById('db-name').value,
        username: document.getElementById('db-user').value,
        password: document.getElementById('db-pass').value,
        apiEndpoint: document.getElementById('db-api').value
      };
      
      localStorage.setItem('db_host', config.host);
      localStorage.setItem('db_port', config.port);
      localStorage.setItem('db_name', config.database);
      localStorage.setItem('db_user', config.username);
      localStorage.setItem('db_pass', config.password);
      localStorage.setItem('db_api', config.apiEndpoint);
      
      alert(currentLang === 'fa' ? 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯' : 'Settings saved');
    }

    function testDBConnection() {
      alert(currentLang === 'fa' ? 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„... (Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ backend Ø¯Ø§Ø±Ø¯)' : 'Testing connection... (requires backend)');
    }

    // ==================== REPORTS ====================
    function showReport(type) {
      const days = type === 'week' ? 7 : 30;
      const now = new Date();
      const from = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      
      const filtered = finance.filter(f => 
        new Date(f.datetime) >= from && f.type === 'Ø¯Ø±ÛŒØ§ÙØªÛŒ'
      );
      
      const sum = filtered.reduce((s, f) => s + f.amount, 0);
      
      const label = type === 'week' 
        ? (currentLang === 'fa' ? 'Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡' : 'Last 7 days')
        : (currentLang === 'fa' ? 'Û³Û° Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡' : 'Last 30 days');
      
      document.getElementById('report-output').innerHTML = 
        `<strong>${label}:</strong> ${filtered.length} ${currentLang === 'fa' ? 'ØªØ±Ø§Ú©Ù†Ø´' : 'transactions'} | <strong>${formatNumber(sum)}</strong>`;
    }

    // ==================== EXPORT/IMPORT ====================
    async function exportData() {
      const data = {
        version: APP_VERSION,
        exportDate: new Date().toISOString(),
        businessInfo,
        currentCurrency,
        licenseData,
        customers,
        services,
        operations,
        finance,
        stages
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `crm-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      addActivity(currentLang === 'fa' ? 'Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§' : 'Data exported');
    }

    async function importData() {
      const input = document.getElementById('import-file');
      if (!input.files || !input.files[0]) {
        alert(currentLang === 'fa' ? 'ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' : 'Select file');
        return;
      }
      
      const file = input.files[0];
      const reader = new FileReader();
      
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          for (let store of ['customers', 'services', 'operations', 'finance', 'stages']) {
            const all = await dbGetAll(store);
            for (let item of all) await dbDelete(store, item.id);
          }
          
          if (data.customers) for (let c of data.customers) await dbSave('customers', c);
          if (data.services) for (let s of data.services) await dbSave('services', s);
          if (data.operations) for (let o of data.operations) await dbSave('operations', o);
          if (data.finance) for (let f of data.finance) await dbSave('finance', f);
          if (data.stages) for (let s of data.stages) await dbSave('stages', s);
          
          if (data.businessInfo) {
            businessInfo = data.businessInfo;
            localStorage.setItem('crm_business_info', JSON.stringify(businessInfo));
            updateBusinessDisplay();
          }
          if (data.currentCurrency) {
            currentCurrency = data.currentCurrency;
            localStorage.setItem('crm_currency', currentCurrency);
          }
          if (data.licenseData) {
            licenseData = data.licenseData;
            localStorage.setItem('crm_license', JSON.stringify(licenseData));
          }
          
          await loadData();
          renderAll();
          alert(currentLang === 'fa' ? 'ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯' : 'Data imported successfully');
          addActivity(currentLang === 'fa' ? 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯' : 'Data imported');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      
      reader.readAsText(file);
    }

    async function resetAllData() {
      if (!confirm(currentLang === 'fa' ? 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯!' : 'Are you sure? All data will be deleted!')) return;
      
      for (let store of ['customers', 'services', 'operations', 'finance', 'stages']) {
        const all = await dbGetAll(store);
        for (let item of all) await dbDelete(store, item.id);
      }
      
      customers = [];
      services = [];
      operations = [];
      finance = [];
      stages = [];
      
      renderAll();
      addActivity(currentLang === 'fa' ? 'Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯' : 'All data deleted');
    }

    // ==================== ACTIVITIES ====================
    function addActivity(text) {
      activities.unshift({
        text,
        time: new Date().toISOString()
      });
      if (activities.length > 50) activities.pop();
      
      renderActivities();
    }

    function renderActivities() {
      const list = document.getElementById('activity-list');
      if (!list) return;
      
      if (activities.length === 0) {
        list.innerHTML = '<li>' + (currentLang === 'fa' ? 'Ø®Ø§Ù„ÛŒ...' : 'Empty...') + '</li>';
        return;
      }
      
      list.innerHTML = activities.slice(0, 10).map(a => `
        <li>${formatDateTime(new Date(a.time))} - ${a.text}</li>
      `).join('');
    }

    function formatDateTime(dt) {
      return dt.toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US') + ' ' + 
             dt.toTimeString().slice(0,5);
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      const searchIds = ['search-customers', 'search-operations', 'search-archive'];
      const tableIds = ['customers-table', 'operations-table', 'archive-table'];
      
      searchIds.forEach((id, idx) => {
        const input = document.getElementById(id);
        if (!input) return;
        
        input.addEventListener('input', () => {
          const q = input.value.toLowerCase();
          const rows = document.querySelectorAll(`#${tableIds[idx]} tbody tr`);
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
          });
        });
      });
    }

    // ==================== START ====================
    window.onload = init;
    
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };
  </script>
</body>

</html>
